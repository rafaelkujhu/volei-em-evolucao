<script>
/* ======================
   CONFIGURAÃ‡Ã•ES GERAIS
====================== */
const fundamentosLista=["Saque","Passe","Ataque","Defesa"];
let atletaAtual=null;

/* METAS POR POSIÃ‡ÃƒO */
const metasPorPosicao={
  "Levantador(a)":{Saque:60,Passe:80,Ataque:55,Defesa:70},
  "Ponteiro(a)":{Saque:70,Passe:70,Ataque:75,Defesa:65},
  "Central":{Saque:60,Passe:65,Ataque:80,Defesa:60},
  "Oposto(a)":{Saque:65,Passe:60,Ataque:80,Defesa:60},
  "LÃ­bero":{Saque:0,Passe:85,Ataque:0,Defesa:85}
};

/* TREINOS POR POSIÃ‡ÃƒO */
const treinosPorPosicao={
  "Levantador(a)":{
    Passe:["Passe em deslocamento","Tomada de decisÃ£o","CoordenaÃ§Ã£o mÃ£os e pernas"],
    Saque:["Saque controle","Rotina tÃ©cnica","ConsistÃªncia"]
  },
  "Central":{
    Ataque:["Tempo de ataque","ImpulsÃ£o controlada","CoordenaÃ§Ã£o salto-braÃ§o"],
    Passe:["Passe simples","Base motora","Controle corporal"]
  },
  "Ponteiro(a)":{
    Ataque:["Ataque em situaÃ§Ã£o real","TransiÃ§Ã£o defesa-ataque","Velocidade + controle"]
  },
  "Oposto(a)":{
    Ataque:["FinalizaÃ§Ã£o forte","ExplosÃ£o","EficiÃªncia ofensiva"]
  },
  "LÃ­bero":{
    Defesa:["Defesa baixa","ReaÃ§Ã£o rÃ¡pida","Leitura de jogo"],
    Passe:["Passe de precisÃ£o","Estabilidade","ConsistÃªncia"]
  }
};

/* ======================
   LOGIN / PERFIL
====================== */
function entrarApp(){
  if(!nome.value||!idade.value||!genero.value||!posicao.value){
    alert("Preencha todo o perfil");
    return;
  }

  atletaAtual = nome.value;

  let atleta = {
    perfil:{
      nome:nome.value,
      idade:idade.value,
      genero:genero.value,
      posicao:posicao.value
    },
    sessoes:[]
  };

  localStorage.setItem(atletaAtual, JSON.stringify(atleta));

  carregarPerfil();
  montarFundamentos();

  telaLogin.classList.add("oculto");
  app.classList.remove("oculto");
}

function carregarPerfil(){
  let atleta = JSON.parse(localStorage.getItem(atletaAtual));
  pNome.innerText=atleta.perfil.nome;
  pIdade.innerText=atleta.perfil.idade;
  pGenero.innerText=atleta.perfil.genero;
  pPosicao.innerText=atleta.perfil.posicao;
}

/* ======================
   FUNDAMENTOS
====================== */
function montarFundamentos(){
  fundamentos.innerHTML="";
  let atleta = JSON.parse(localStorage.getItem(atletaAtual));
  let pos = atleta.perfil.posicao;

  fundamentosLista.forEach(f=>{
    let meta = metasPorPosicao[pos][f];
    fundamentos.innerHTML+=`
    <div class="card">
      <h3>${f}</h3>
      <div class="grid-inputs">
        <input id="${f}A" type="number" placeholder="Acertos">
        <input id="${f}E" type="number" placeholder="Erros">
      </div>
      <div class="progress">
        <div id="bar${f}" class="progress-bar"></div>
      </div>
      <div class="meta">
        <span>Meta ${meta}%</span>
        <span id="txt${f}">0%</span>
      </div>
    </div>`;
  });
}

/* ======================
   ANÃLISE + SALVAR
====================== */
function analisar(){
  let atleta = JSON.parse(localStorage.getItem(atletaAtual));
  let pos = atleta.perfil.posicao;

  let sessao = {
    data: new Date().toLocaleString(),
    fundamentos:[]
  };

  fundamentosLista.forEach(f=>{
    let A=+document.getElementById(f+"A").value||0;
    let E=+document.getElementById(f+"E").value||0;
    let pct=A+E?Math.round(A/(A+E)*100):0;

    sessao.fundamentos.push({nome:f,pct});
    atualizarBarra(f,pct,metasPorPosicao[pos][f]);
  });

  atleta.sessoes.push(sessao);
  localStorage.setItem(atletaAtual, JSON.stringify(atleta));

  gerarTreino(pos, sessao);
  renderizarGrafico(sessao.fundamentos);
}

/* ======================
   BARRAS
====================== */
function atualizarBarra(f,pct,meta){
  let b=document.getElementById("bar"+f);
  let t=document.getElementById("txt"+f);
  t.innerText=pct+"%";
  b.style.width=pct+"%";
  b.className="progress-bar "+(pct<meta?"pb-red":pct<meta+10?"pb-yellow":"pb-green");
}

/* ======================
   TREINO AUTOMÃTICO
====================== */
function gerarTreino(posicao,sessao){
  let pior = sessao.fundamentos.reduce((a,b)=>a.pct<b.pct?a:b);
  let lista = treinosPorPosicao[posicao]?.[pior.nome];

  let html=`<div class="resultado">
  ðŸ“‹ <strong>Treino sugerido (${pior.nome})</strong><br>`;

  if(lista){
    lista.forEach(i=>html+=`â€¢ ${i}<br>`);
  }else{
    html+=`â€¢ Treino tÃ©cnico geral<br>â€¢ Base motora<br>â€¢ Controle`;
  }

  html+="</div>";
  saida.innerHTML=html;
}

/* ======================
   DASHBOARD (CORRIGIDO)
====================== */
function renderizarGrafico(dados){
  let canvas = document.getElementById("grafico");
  let ctx = canvas.getContext("2d");

  ctx.clearRect(0,0,canvas.width,canvas.height);

  dados.forEach((f,i)=>{
    let altura = f.pct * 1.4;
    ctx.fillStyle="#3f51b5";
    ctx.fillRect(30+i*80,160-altura,46,altura);
    ctx.fillText(f.nome,30+i*80,175);
    ctx.fillText(f.pct+"%",35+i*80,145-altura);
  });
}

/* ======================
   OUTROS
====================== */
function gerarPDF(){ window.print(); }

function sair(){
  app.classList.add("oculto");
  telaLogin.classList.remove("oculto");
}
</script>
